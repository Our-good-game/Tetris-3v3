<!DOCTYPE html>
<html>

<head>
  <script src='/JS/timer.js'></script>
  <script src='/JS/render.js'></script>
  <script src='/JS/player-interface.js'></script>
  <script src='/JS/items.js'></script>
  <script src='/JS/classic-tetris-3v3.js'></script>
  <script src='/socket.io/socket.io.js'></script>
  <script src='/JS/size.js'></script>
  <script src='/JS/heart&&shield.js'></script>
  <script src='/JS/EnergyBar.js'></script>
  <script src='/JS/Profession.js'></script>
  <style>
    @import"/CSS/style.css";
    @import"/CSS/energyBar.css";
    @font-face {
      font-family: huakang_girl_w5;
      src: url(/CSS/huakang_girl_w5.ttf);
    }
    .btn_ani {
      transition: all 0.3s;
    }
    .btn_ani:hover {
      transform: scale(1.3);
    }
  </style>
  
</head>

<body>
  <div style='user-select: none;'>
    <!-- 載入huakang_girl_w5字體 -->
    <div style='font-family: huakang_girl_w5; font-size: 0px;'>Combo</div>
    <canvas id='js-background'></canvas>
    <div>
      
      <div class='container' id ='playInterface' style="display: none;"> 
        <canvas id='HUD' style="position:absolute;"></canvas>
        <img src="/picture/heart.png" id ="heart" style="display:none"></img>
        <img src="/picture/shield.png" id ="shield" style="display:none"></img>


        <div class="meter" style="height: 40%; position:absolute; top: 0px; left: 0px; ">
          <span id="energy" style="height: 0%"></span>
        </div>

        <canvas id='player' class='tetris-canvas' style="height: 85%;"></canvas>
        <canvas id='teammate1' class='tetris-canvas' style="position:absolute; height: 40%;"></canvas>
        <canvas id='teammate2' class='tetris-canvas' style="position:absolute; height: 40%;"></canvas>
      
        <canvas id='opponent1' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
        <canvas id='opponent2' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
        <canvas id='opponent3' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
      </div>
      <div class='container' id ='findInterface' style="display: block;">
        <div style=" text-align: center; margin: 15% auto; flex-direction: row;height: 100%; width: 50%;">
          <div style="margin: 15% auto; width: 50%;">
            <div class= 'playername'><pre id = 'left1' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right1' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
            <div class= 'playername'><pre id = 'left2' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right2' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
            <div class= 'playername'><pre id = 'left3' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right3' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
          </div>
          <div id='control' style='display: none; left:45%; top:50%; z-index: 3; position:fixed; text-align: center; display: block;'>
            <button class = "btn_ani" id='start-stop-btn' style='display: none;'>Play</button><br>
            <button class = "btn_ani" id='find' style='display: none;'>find</button><br>
            <input class = "btn_ani" style='display: none;' type="button" onclick="javascript:location.href='index.html'" value="Quit" />
            <pre id = 'roomNumber-out' style='display: none;'>room - </pre>
          </div>
          <button class = "btn_ani" onclick="changeTeam()">Change</button>
          <button class = "btn_ani" onclick="start()">Start</button>
          <input class = "btn_ani" type="button" onclick="javascript:location.href='index.html'" value="Quit">
        </div>
      </div>
    </div>
  </div>
 
<script src="/JS/background.js"></script>
<script>

  var HUD = document.getElementById('HUD');
  HUD.height = window.innerHeight * 0.15;
  HUD.width = window.innerWidth;

  var player = document.getElementById('player');
  player.height = window.innerHeight;
  player.width = window.innerWidth * 0.45;
  player.style.top = HUD.height + "px";
  player.style.left = window.innerWidth / 3.5 + "px";

  var teammate1 = document.getElementById('teammate1');
  teammate1.height = window.innerHeight;
  teammate1.width = window.innerWidth * 0.45;
  teammate1.style.top = HUD.height + "px";
  teammate1.style.left = window.innerWidth / 15 + "px";

  var teammate2 = document.getElementById('teammate2');
  teammate2.height = window.innerHeight;
  teammate2.width = window.innerWidth * 0.45;
  teammate2.style.top = (HUD.height +  teammate2.height * 0.4) + "px";
  teammate2.style.left = window.innerWidth / 15 + "px";
/* ----------------------------------------------------------------------------------------------*/
  var opponent1 = document.getElementById('opponent1');
  opponent1.height = window.innerHeight
  opponent1.width = window.innerWidth * 0.45;
  opponent1.style.top = HUD.height + "px";
  opponent1.style.left = window.innerWidth * 0.75 + "px";

  var opponent2 = document.getElementById('opponent2');
  opponent2.height = window.innerHeight;
  opponent2.width = window.innerWidth * 0.45;
  opponent2.style.top = (HUD.height +  opponent2.height * 0.4) + "px";
  opponent2.style.left = window.innerWidth * 0.67 + "px";

  var opponent3 = document.getElementById('opponent3');
  opponent3.height = window.innerHeight;
  opponent3.width = window.innerWidth * 0.45;
  opponent3.style.top = (HUD.height +  opponent3.height * 0.4) + "px";
  opponent3.style.left = window.innerWidth * 0.83 + "px";
  
  var draw = new Render();
  // 主遊戲邏輯
  var gamecore = new ClassicTetris3v3();  
  // 隊友遊戲資料       
  var teammate1Core = new PlayerInterface(); 
  var teammate2Core = new PlayerInterface();
  // 敵人遊戲資料
  var opponent1Core = new PlayerInterface(); 
  var opponent2Core = new PlayerInterface();
  var opponent3Core = new PlayerInterface();

  var myCanvas = new teamModSize (player);
  var teammate1Canvas = new teamModSize (teammate1);
  var teammate2Canvas = new teamModSize (teammate2);
  var opponent1Canvas = new teamModSize (opponent1);
  var opponent2Canvas = new teamModSize (opponent2);
  var opponent3Canvas = new teamModSize (opponent3);

  var teamHeart = new heart("left", HUD)
  var opponentHeart = new heart("right", HUD)
  let teamShield = new shield("left", HUD)
  let opponentShield = new shield("right", HUD)
  // 能量條
  var energyBar = new EnergyBar (document.getElementsByClassName('meter')[0], document.getElementById('energy'));
  var socket = io()
  var config = {
    id: undefined,
    team: undefined,       // left or right
    teamNumber: 0,         // 1 2 3
    profession: undefined, // ['Attacker', 'Defender', 'Magician']
  }
  var myProfession 

  window.onload = function () {
    fetch('id')
      .then(function (response) { return response.text(); })
      .then(function (data) {
        myCanvas.playerName = data;
        config.id = data;
        socket.emit("idstore", config.id)
        socket.emit('enterRoom', config)
      })
    
  }
  function SendData(data) {
    if(myProfession.action){gamecore._getItem()}
    let datatmp = {
      gameLoop: data.gameLoop,
      gameState: data.gameState,
      board: data.board,
      piecePosition: data.piecePosition,
      pieceRotation: data.pieceRotation,
      piece: data.piece,
      next:[data.next[0],data.next[1],data.next[2]],
      haveHold: data.haveHold,
      holdPiece: data.holdPiece,
      lines: data.lines,
      burnOn: data.burnOn,
      result: data.result,
      getItem: data.getItem
    }
    socket.emit('teamGamming', datatmp, config, myProfession.action)
    myProfession.action = false
  };
  function changeTeam(){
    socket.emit('enterRoom', config, "change")
  }
  function start(){
    socket.emit('teamFight',config)
  }
  function _loadData(Core, Canvas, data){
    // console.log(data)
    Core.gameLoop = data.gameLoop
    Core.gameState = data.gameState
    Core.board = data.board;
    Core.piecePosition = data.piecePosition
    Core.pieceRotation = data.pieceRotation
    Core.piece = data.piece
    for (let i = 0; i < 3; ++i)Core.next[i] = data.next[i]
    Core.haveHold = data.haveHold
    Core.holdPiece = data.holdPiece
    Core.lines = data.lines
    Core.result = data.result
    gamecore.raise += 0
    if(!data.result){
      gamecore._triggerGameOver()
    }
    draw._renderNoHUD(Core, Canvas);
    // console.log (Canvas.playerName);
  }
  function repaintHUD() {
    HUD.getContext("2d").clearRect(0, 0, HUD.width, HUD.height);
      teamHeart.paint();
      opponentHeart.paint();
      teamShield.paint();
      opponentShield.paint();
  }
  window.addEventListener('load', event => {
    _startStopBtn = event => {
      /*
      timer.settime(P1canvas.togglePlayPause());
      /*/
      P1canvas._disableUI()
      gamecore.togglePlayPause()
      //*/
      if (p2 !== undefined) socket.emit('fight', p2);
    };document.getElementById('start-stop-btn').addEventListener('click', _startStopBtn );
    /*
    document.getElementById('GameOver-btn').addEventListener('click', event => {
      P1canvas.quit()
    });
    */
    _find = event => {
      document.getElementById('control').style.display = "none"
      document.getElementById('room').style.display = "block"
    };document.getElementById('find').addEventListener('click',_find);
  })

  socket.on('teamGamming', function (data, dataConfig, actType) {
    //console.log(dataConfig)
    console.log(actType)
    if(dataConfig.id == teammate1Canvas.playerName)
      _loadData(teammate1Core, teammate1Canvas, data)
    if(dataConfig.id == teammate2Canvas.playerName)
      _loadData(teammate2Core, teammate2Canvas, data);
    if(dataConfig.id == opponent1Canvas.playerName) 
      _loadData(opponent1Core, opponent1Canvas, data);
    if(dataConfig.id == opponent2Canvas.playerName)
      _loadData(opponent2Core, opponent2Canvas, data);
    if(dataConfig.id == opponent3Canvas.playerName)
      _loadData(opponent3Core, opponent3Canvas, data);
    switch(actType){
      case 'Attacker':
        if(dataConfig.team !== config.team) {
          if(opponentShield.life > 0) opponentShield.life--
          else opponentHeart.life--
        } else {
          if(teamShield.life > 0) teamShield.life--
          else teamHeart.life--
        } 
      break;
      case 'Defender':
        if(dataConfig.team !== config.team){
          teamShield.life = Math.min(teamShield.life+1, 3)
        }else {
          opponentShield.life = Math.min(opponentShield.life+1, 3)
        }
      break;
      case 'Magician':
        if( dataConfig.team !== config.team || data.getItem == 'Defense'){
          gamecore.getItem = data.getItem
          console.log( gamecore.getItem )
          gamecore._itemProcess()
        }
      break;
    }
    repaintHUD()
  })
  socket.on('roomInfo', function (roomData) {
    let tmp1 = ["left","right"]
    let tmp2 = ['1','2','3']
    let tmp3 = ['Attacker', 'Defender', 'Magician']
    for(let i=0; i<2; ++i)
      for(let j=0; j<3; ++j){ 
        document.getElementById(tmp1[i]+tmp2[j]).textContent = roomData[i][j]
        if(roomData[i][j] == config.id){
          if(i == 0) config.team = 'left'
          else config.team = 'right'
          config.teamNumber = j+1;
          config.profession = tmp3[j]
          myProfession = new profession(config)
        }
      }
    
  })
  socket.on('teamFight', function(roomData){
    document.getElementById('findInterface').style.display = "none";
    document.getElementById('playInterface').style.display = "flex";
    draw._render(gamecore, myCanvas);
    draw._renderNoHUD(teammate1Core, teammate1Canvas);
    draw._renderNoHUD(teammate2Core, teammate2Canvas);
    draw._renderNoHUD(opponent1Core, opponent1Canvas);
    draw._renderNoHUD(opponent2Core, opponent2Canvas);
    draw._renderNoHUD(opponent3Core, opponent3Canvas);
    let pos;
    if(config.team == 'left')pos = 0
    else pos = 1
    teammate1Canvas.playerName = roomData[pos][config.teamNumber%3]
    teammate2Canvas.playerName = roomData[pos][(config.teamNumber+1)%3]
    opponent1Canvas.playerName = roomData[(pos+1)%2][0]
    opponent2Canvas.playerName = roomData[(pos+1)%2][1]
    opponent3Canvas.playerName = roomData[(pos+1)%2][2]
    console.log(teammate1Canvas.playerName)
    console.log(teammate2Canvas.playerName)
    console.log(opponent1Canvas.playerName)
    console.log(opponent2Canvas.playerName)
    console.log(opponent3Canvas.playerName)
    repaintHUD()
    // socket.emit ('defend', config);
    myCanvas._disableUI()
    gamecore.togglePlayPause()
  })
 
</script>

</html>