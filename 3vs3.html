<!DOCTYPE html>
<html>

<head>
  <script src='/JS/timer.js'></script>
  <script src='/JS/render.js'></script>
  <script src='/JS/player-interface.js'></script>
  <script src='/JS/classic-tetris-3v3.js'></script>
  <script src='/JS/classic-tetris.js'></script>
  <script src='/socket.io/socket.io.js'></script>
  <script src='/JS/size.js'></script>
  <script src='/JS/heart.js'></script>
  <script src='/JS/shield.js'></script>
  <script src='/JS/EnergyBar.js'></script>
  <script src='/JS/Profession.js'></script>
  <style>
    @import"/CSS/style.css";
    @import"/CSS/energyBar.css";
    @font-face {
      font-family: huakang_girl_w5;
      src: url(/CSS/huakang_girl_w5.ttf);
    }
  </style>
  
</head>

<body>
  <div style='user-select: none;'>
    <!-- 載入huakang_girl_w5字體 -->
    <div style='font-family: huakang_girl_w5; font-size: 0px;'>Combo</div>
    <canvas id='js-background'></canvas>
    <div>
      <div id='player-name'
        style="position:absolute; top:100px; left:100px; color:rgb(54, 170, 238); font:36px georgia">
      </div>
      <div id='player2-name'
        style="position:absolute; top:100px; left:1000px; color:rgb(54, 170, 238); font:36px georgia">
      </div>
      <div class='container' id ='playInterface' style="display: none;"> 
        <canvas id='HUD' style="position:absolute;"></canvas>
        <img src="/picture/heart.png" id ="heart" style="display:none"></img>
        <img src="/picture/shield.png" id ="shield" style="display:none"></img>


        <div class="meter" style="height: 40%; position:absolute; top: 0px; left: 0px; ">
          <span id="energy" style="height: 0%"></span>
        </div>

        <canvas id='player' class='tetris-canvas' style="height: 85%;"></canvas>
        <canvas id='teammate1' class='tetris-canvas' style="position:absolute; height: 40%;"></canvas>
        <canvas id='teammate2' class='tetris-canvas' style="position:absolute; height: 40%;"></canvas>
      
        <canvas id='opponent1' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
        <canvas id='opponent2' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
        <canvas id='opponent3' class='tetris-canvas' style="position:absolute; height: 35%;"></canvas>
      </div>
      <div class='container' id ='findInterface' style="display: block;">
        <div style=" text-align: center; margin: 15% auto; flex-direction: row;height: 100%; width: 50%;">
          <div style="margin: 15% auto; width: 50%;">
            <div class= 'playername'><pre id = 'left1' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right1' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
            <div class= 'playername'><pre id = 'left2' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right2' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
            <div class= 'playername'><pre id = 'left3' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div>
            <div class= 'playername'><pre id = 'right3' style="height: 100%;width: 100%; margin: 1px;padding: 5px;">Unknow</pre></div></br>
          </div>
          <div id='control' style='display: none; left:45%; top:50%; z-index: 3; position:fixed; text-align: center; display: block;'>
            <button id='start-stop-btn' style='display: none;'>Play</button><br>
            <button id='find' style='display: none;'>find</button><br>
            <input style='display: none;' type="button" onclick="javascript:location.href='index.html'" value="Quit" />
            <pre id = 'roomNumber-out' style='display: none;'>room - </pre>
          </div>
          <button onclick="changeTeam()">Change</button>
          <button onclick="start()">Start</button>
          <input type="button" onclick="javascript:location.href='index.html'" value="Quit">
        </div>
      </div>
    </div>
  </div>
 
<script src="/JS/background.js"></script>
<script>

  var HUD = document.getElementById('HUD');
  HUD.height = window.innerHeight * 0.15;
  HUD.width = window.innerWidth;

  var player = document.getElementById('player');
  player.height = window.innerHeight;
  player.width = window.innerWidth * 0.45;
  player.style.top = HUD.height + "px";
  player.style.left = window.innerWidth / 3.5 + "px";

  var teammate1 = document.getElementById('teammate1');
  teammate1.height = window.innerHeight;
  teammate1.width = window.innerWidth * 0.45;
  teammate1.style.top = HUD.height + "px";
  teammate1.style.left = window.innerWidth / 15 + "px";

  var teammate2 = document.getElementById('teammate2');
  teammate2.height = window.innerHeight;
  teammate2.width = window.innerWidth * 0.45;
  teammate2.style.top = (HUD.height +  teammate2.height * 0.4) + "px";
  teammate2.style.left = window.innerWidth / 15 + "px";
/* ----------------------------------------------------------------------------------------------*/
  var opponent1 = document.getElementById('opponent1');
  opponent1.height = window.innerHeight
  opponent1.width = window.innerWidth * 0.45;
  opponent1.style.top = HUD.height + "px";
  opponent1.style.left = window.innerWidth * 0.75 + "px";

  var opponent2 = document.getElementById('opponent2');
  opponent2.height = window.innerHeight;
  opponent2.width = window.innerWidth * 0.45;
  opponent2.style.top = (HUD.height +  opponent2.height * 0.4) + "px";
  opponent2.style.left = window.innerWidth * 0.67 + "px";

  var opponent3 = document.getElementById('opponent3');
  opponent3.height = window.innerHeight;
  opponent3.width = window.innerWidth * 0.45;
  opponent3.style.top = (HUD.height +  opponent3.height * 0.4) + "px";
  opponent3.style.left = window.innerWidth * 0.83 + "px";
  
  var draw = new Render();
  // 主遊戲邏輯
  var gamecore = new ClassicTetris3v3();  
  // 隊友遊戲資料       
  var teammate1Core = new PlayerInterface(); 
  var teammate2Core = new PlayerInterface();
  // 敵人遊戲資料
  var opponent1Core = new PlayerInterface(); 
  var opponent2Core = new PlayerInterface();
  var opponent3Core = new PlayerInterface();

  var myCanvas = new teamModSize (player);
  var teammate1Canvas = new teamModSize (teammate1);
  var teammate2Canvas = new teamModSize (teammate2);
  var opponent1Canvas = new teamModSize (opponent1);
  var opponent2Canvas = new teamModSize (opponent2);
  var opponent3Canvas = new teamModSize (opponent3);

  let ourLiveHeart = 5;
  let opponentLiveHeart = 5;
  let ourLiveShield = 0;
  let opponentLiveShield = 0;
  
  var teamHeart = new Array(5)
  var opponentHeart = new Array(5)
  let teamShield = new Array(5);
  let opponentShield = new Array(5);

  for (let i = 1; i<= 5; ++i) {
    teamHeart[i] = new heart(i, "left", HUD)
    opponentHeart[i] = new heart(i, "right", HUD)
  }
  
  // 能量條
  var energyBar = new EnergyBar (document.getElementsByClassName('meter')[0], document.getElementById('energy'));
  
  var socket = io()
  var config = {
    id: undefined,
    team: undefined,       // left or right
    teamNumber: 0,         // 1 2 3
    profession: undefined, // defind attack annoy
  }
 

  window.onload = function () {
    fetch('id')
      .then(function (response) { return response.text(); })
      .then(function (data) {
        myCanvas.playerName = data;
        config.id = data;
        socket.emit("idstore", config.id)
        socket.emit('enterRoom',config)
      })
    
  }
  function SendData(data) {
    let datatmp = {
      gameState: data.gameState,
      board: data.board,
      piecePosition: data.piecePosition,
      pieceRotation: data.pieceRotation,
      piece: data.piece,
      haveHold: data.haveHold,
      holdPiece: data.holdPiece,
      lines: data.lines,
      next:[data.next[0],data.next[1],data.next[2]],
      burnOn: data.burnOn,
      result: data.result
    }
    socket.emit('teamGamming',data,config)
  };
  function changeTeam(){
    socket.emit('enterRoom',config, "change")
  }
  function start(){
    socket.emit('teamFight',config)
  }
  function _loadData(Core, Canvas, data){
    // console.log(data)
    Core.gameLoop = data.gameLoop
    Core.gameState = data.gameState
    Core.board = data.board;
    Core.linesCleared = data.linesCleared
    Core.piecePosition = data.piecePosition
    Core.pieceRotation = data.pieceRotation
    Core.piece = data.piece
    for (let i = 0; i < 3; ++i)Core.next[i] = data.next[i]
    Core.haveHold = data.haveHold
    Core.holdPiece = data.holdPiece
    Core.lines = data.lines
    Core.result = data.result
    gamecore.raise += 0
    if(!data.result){
      gamecore._triggerGameOver()
    }
    draw._renderNoHUD(Core, Canvas);
    // console.log (Canvas.playerName);
  }
  function repaintHUD() {
    HUD.getContext("2d").clearRect(0, 0, HUD.width, HUD.height);
    for (let i = 1; i<= ourLiveHeart; ++i) {
      teamHeart[i].paint();
    }
    for (let i = 1; i<= opponentLiveHeart; ++i) {
      opponentHeart[i].paint();
    }
    for (let i = 1; i<= ourLiveShield; ++i) {
      teamShield[i].paint();
    }
    for (let i = 1; i<= opponentLiveShield; ++i) {
      opponentShield[i].paint();
    }    
  }
  window.addEventListener('load', event => {

    // fetch('id')
    //   .then(function (response) { return response.text(); })
    //   .then(function (data) {
    //     id = data;
    //     P1canvas.playerName = id;
    //     draw._render(gamecore, P1canvas);
    //     socket.emit("idstore", id)
    //   })
    _startStopBtn = event => {
      /*
      timer.settime(P1canvas.togglePlayPause());
      /*/
      P1canvas._disableUI()
      gamecore.togglePlayPause()
      //*/
      if (p2 !== undefined) socket.emit('fight', p2);
    };document.getElementById('start-stop-btn').addEventListener('click', _startStopBtn );
    /*
    document.getElementById('GameOver-btn').addEventListener('click', event => {
      P1canvas.quit()
    });
    */
    _find = event => {
      document.getElementById('control').style.display = "none"
      document.getElementById('room').style.display = "block"
    };document.getElementById('find').addEventListener('click',_find);
  })

  socket.on('teamGamming', function (data, dataConfig) {
    //console.log(dataConfig)
    if(dataConfig.id == teammate1Canvas.playerName)
      _loadData(teammate1Core, teammate1Canvas, data)
    if(dataConfig.id == teammate2Canvas.playerName)
      _loadData(teammate2Core, teammate2Canvas, data);
    if(dataConfig.id == opponent1Canvas.playerName) 
      _loadData(opponent1Core, opponent1Canvas, data);
    if(dataConfig.id == opponent2Canvas.playerName)
      _loadData(opponent2Core, opponent2Canvas, data);
    if(dataConfig.id == opponent3Canvas.playerName)
      _loadData(opponent3Core, opponent3Canvas, data);
  })
  socket.on('roomInfo', function (roomData) {
    let tmp1 = ["left","right"]
    let tmp2 = ['1','2','3']
   
    for(let i=0; i<2; ++i)
      for(let j=0; j<3; ++j){ 
        document.getElementById(tmp1[i]+tmp2[j]).textContent = roomData[i][j]
        if(roomData[i][j] == config.id){
          if(i == 0) config.team = 'left'
          else config.team = 'right'
          config.teamNumber = j+1;
        }
      }
  })
  socket.on('teamFight', function(roomData){
    document.getElementById('findInterface').style.display = "none";
    document.getElementById('playInterface').style.display = "flex";
    draw._render(gamecore, myCanvas);
    draw._renderNoHUD(teammate1Core, teammate1Canvas);
    draw._renderNoHUD(teammate2Core, teammate2Canvas);
    draw._renderNoHUD(opponent1Core, opponent1Canvas);
    draw._renderNoHUD(opponent2Core, opponent2Canvas);
    draw._renderNoHUD(opponent3Core, opponent3Canvas);
    let pos;
    if(config.team == 'left')pos = 0
    else pos = 1
    teammate1Canvas.playerName = roomData[pos][config.teamNumber%3]
    teammate2Canvas.playerName = roomData[pos][(config.teamNumber+1)%3]
    opponent1Canvas.playerName = roomData[(pos+1)%2][0]
    opponent2Canvas.playerName = roomData[(pos+1)%2][1]
    opponent3Canvas.playerName = roomData[(pos+1)%2][2]
    console.log(teammate1Canvas.playerName)
    console.log(teammate2Canvas.playerName)
    console.log(opponent1Canvas.playerName)
    console.log(opponent2Canvas.playerName)
    console.log(opponent3Canvas.playerName)
    for (let i = 1; i<= 5; ++i){
      teamHeart[i].paint()
      opponentHeart[i].paint()
    }
    if (config.teamNumber == 1) config.profession = new Attacker();
    if (config.teamNumber == 2) config.profession = new Defender();
    if (config.teamNumber == 3) config.profession = new Magician();
    // socket.emit ('defend', config);
    myCanvas._disableUI()
    gamecore.togglePlayPause()
  })
  socket.on ('attack', function (attackerConfig) {
    console.log (config.id + " receive attack");
    if (config.team == attackerConfig.team) {
      if (opponentLiveShield > 0) {
        opponentLiveShield--;    
      }
      else { 
        opponentLiveHeart--;
      }
    }  
    else {
      if (ourLiveShield > 0) {
        ourLiveShield--; 
      }
      else {
        ourLiveHeart--;
      }
    }
    repaintHUD();
  })

  socket.on ('defend', function (attackerConfig) {
    console.log (config.id + " receive defend");
    if (config.team == attackerConfig.team) {
      ourLiveShield = Math.min (5, ++ourLiveShield);
      teamShield[ourLiveShield] = new shield(ourLiveShield, "left", HUD);
    }  
    else {
      opponentLiveShield = Math.min (5, ++opponentLiveShield);
      opponentShield[opponentLiveShield] = new shield(opponentLiveShield, "right", HUD);
    }
    repaintHUD();
  })
</script>

</html>